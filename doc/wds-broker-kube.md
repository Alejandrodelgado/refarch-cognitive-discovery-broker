# WDS Broker deployment as container on Kubernetes pods

The Watson Discovery Broker code is packaged as a container and deployed to Bluemix Kubernetes Service.

The docker file is using the node:alpine image from docker public repository. Alpine is the lightweight operating system. The exposed port is 6010.

` docker build -t case/wdsbroker .`
It can be run locally instead of using the npm run dev by using the command:
`docker run -d -p 6010:6010 -t case/wdsbroker`

The image once built is uploaded to the Bluemix private container registry `registry.ng.bluemix.net/<namespace>/<imagename>`  with commands like:

```
bx login -a https://api.ng.bluemix.net

bx cr namespaces

docker tag case/wdsbroker  registry.ng.bluemix.net/ibm_mls/casewdsbroker

bx cr login
docker push registry.ng.bluemix.net/ibm_mls/casewdsbroker
```

Once the image is uploaded it is possible to build a Kubernetes Deployment and deploy the container to the pods.

```
# Get cluster information
$ kubectl cluster-info

# Get nodes information
$ kubectl get nodes

# Create a Deployment and run it on the pods
$ kubectl run casewdsbroker --image=registry.ng.bluemix.net/ibm_mls/casewdsbroker --port=6010

# Get deployment list
$ kubectl get deployments

# Get pod list
$ kubectl get pods

# Get workers IP address
$ bx cs workers cyancomputecluster

Listing cluster workers...
OK
ID                                                 Public IP         Private IP     Machine Type   State    Status   
kube-hou02-pa523a20b106d8494d9e379d587f3b807a-w1   184.172.242.164   10.47.87.155   free           normal   Ready  


# Get details for the pods
$ kubectl describe pods
```

To verify the logs generated by the application:
`kubectl logs $POD_NAME`

To make the container visible to public cloud, we need to create a Kubernetes Service:
```
$ kubectl get services

$ kubectl expose casewdsbroker --type="NodePort" --port 6010

$ export NODE_PORT=$(kubectl get services/casewdsbroker -o go-template='{{(index .spec.ports 0).nodePort}}')

```
So from the Worker public IP address and the node port the URL to access the Broker User interface looks like: `http://184.172.242.164:32571/wdsWeather`
